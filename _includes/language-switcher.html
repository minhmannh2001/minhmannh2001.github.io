{% comment %} 
  Global Language Switcher - Shows on all pages
  For posts: switches to other language version if available
  For other pages: sets language preference for filtering
{% endcomment %}
{% assign detected_lang = 'vi' %}
{% assign other_version_url = '' %}
{% assign has_specific_link = false %}

{% comment %} Detect current language from page path {% endcomment %}
{% if page.path %}
  {% assign filename = page.path | split: '/' | last %}
  {% if filename contains '-en.markdown' or filename contains '-en.md' %}
    {% assign detected_lang = 'en' %}
  {% elsif filename contains '-vi.markdown' or filename contains '-vi.md' %}
    {% assign detected_lang = 'vi' %}
  {% endif %}
{% endif %}

{% comment %} For post pages, check if other language version exists {% endcomment %}
{% if page.layout == 'post' %}
  {% assign current_path = page.path %}
  {% assign filename = current_path | split: '/' | last %}
  {% assign other_lang = '' %}
  {% assign base_name_without_lang = '' %}
  
  {% if filename contains '-en.markdown' %}
    {% assign detected_lang = 'en' %}
    {% assign base_name_without_lang = filename | replace: '-en.markdown', '' %}
    {% assign other_lang = 'vi' %}
  {% elsif filename contains '-en.md' %}
    {% assign detected_lang = 'en' %}
    {% assign base_name_without_lang = filename | replace: '-en.md', '' %}
    {% assign other_lang = 'vi' %}
  {% elsif filename contains '-vi.markdown' %}
    {% assign detected_lang = 'vi' %}
    {% assign base_name_without_lang = filename | replace: '-vi.markdown', '' %}
    {% assign other_lang = 'en' %}
  {% elsif filename contains '-vi.md' %}
    {% assign detected_lang = 'vi' %}
    {% assign base_name_without_lang = filename | replace: '-vi.md', '' %}
    {% assign other_lang = 'en' %}
  {% endif %}
  
  {% if base_name_without_lang != '' %}
    {% comment %} First check site.posts (for actual posts) {% endcomment %}
    {% for post in site.posts %}
      {% assign post_path_parts = post.path | split: '/' %}
      {% assign post_filename = post_path_parts | last %}
      {% assign post_base_name = post_filename %}
      {% if post_filename contains '-en.markdown' %}
        {% assign post_base_name = post_filename | replace: '-en.markdown', '' %}
      {% elsif post_filename contains '-en.md' %}
        {% assign post_base_name = post_filename | replace: '-en.md', '' %}
      {% elsif post_filename contains '-vi.markdown' %}
        {% assign post_base_name = post_filename | replace: '-vi.markdown', '' %}
      {% elsif post_filename contains '-vi.md' %}
        {% assign post_base_name = post_filename | replace: '-vi.md', '' %}
      {% else %}
        {% assign post_base_name = '' %}
      {% endif %}
      
      {% if post_base_name == base_name_without_lang and post_base_name != '' %}
        {% assign post_lang = '' %}
        {% if post_filename contains '-en.markdown' or post_filename contains '-en.md' %}
          {% assign post_lang = 'en' %}
        {% elsif post_filename contains '-vi.markdown' or post_filename contains '-vi.md' %}
          {% assign post_lang = 'vi' %}
        {% endif %}
        
        {% if post_lang == other_lang %}
          {% assign has_specific_link = true %}
          {% assign other_version_url = post.url | prepend: site.baseurl | replace: '//', '/' %}
          {% break %}
        {% endif %}
      {% endif %}
    {% endfor %}
    
    {% comment %} If not found in posts, check site.pages (for pages using post layout) {% endcomment %}
    {% unless has_specific_link %}
      {% for site_page in site.pages %}
        {% assign page_path_parts = site_page.path | split: '/' %}
        {% assign page_filename = page_path_parts | last %}
        {% assign page_base_name = page_filename %}
        {% if page_filename contains '-en.md' %}
          {% assign page_base_name = page_filename | replace: '-en.md', '' %}
        {% elsif page_filename contains '-vi.md' %}
          {% assign page_base_name = page_filename | replace: '-vi.md', '' %}
        {% else %}
          {% assign page_base_name = '' %}
        {% endif %}
        
        {% if page_base_name == base_name_without_lang and page_base_name != '' %}
          {% assign page_lang = '' %}
          {% if page_filename contains '-en.md' %}
            {% assign page_lang = 'en' %}
          {% elsif page_filename contains '-vi.md' %}
            {% assign page_lang = 'vi' %}
          {% endif %}
          
          {% if page_lang == other_lang %}
            {% assign has_specific_link = true %}
            {% if site_page.permalink %}
              {% assign other_version_url = site_page.permalink | prepend: site.baseurl | replace: '//', '/' %}
            {% else %}
              {% assign other_version_url = site_page.url | prepend: site.baseurl | replace: '//', '/' %}
            {% endif %}
            {% break %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endunless %}
  {% endif %}
{% else %}
  {% comment %} For non-post pages, check if other language version exists {% endcomment %}
  {% assign page_filename = page.path | split: '/' | last %}
  {% assign page_base_name = page_filename %}
  {% assign page_other_lang = '' %}
  
  {% if page_filename contains '-en.md' %}
    {% assign detected_lang = 'en' %}
    {% assign page_base_name = page_filename | replace: '-en.md', '' %}
    {% assign page_other_lang = 'vi' %}
  {% elsif page_filename contains '-vi.md' %}
    {% assign detected_lang = 'vi' %}
    {% assign page_base_name = page_filename | replace: '-vi.md', '' %}
    {% assign page_other_lang = 'en' %}
  {% endif %}
  
  {% if page_base_name != '' and page_other_lang != '' %}
    {% assign other_page_filename = page_base_name | append: '-' | append: page_other_lang | append: '.md' %}
    {% for site_page in site.pages %}
      {% comment %} Check both by path and by permalink {% endcomment %}
      {% if site_page.path == other_page_filename or site_page.path contains other_page_filename %}
        {% assign has_specific_link = true %}
        {% if site_page.permalink %}
          {% assign other_version_url = site_page.permalink | prepend: site.baseurl | replace: '//', '/' %}
        {% else %}
          {% assign other_version_url = site_page.url | prepend: site.baseurl | replace: '//', '/' %}
        {% endif %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% comment %} Always show language switcher {% endcomment %}
{% if has_specific_link %}
  <li class="language-switcher-nav">
    <a href="{{ other_version_url }}" class="language-switcher-link" data-lang-switch="true" data-current-lang="{{ detected_lang }}" title="Switch to {% if detected_lang == 'en' %}Vietnamese{% else %}English{% endif %}">
      <span class="current-lang">{% if detected_lang == 'en' %}EN{% else %}VI{% endif %}</span> / <span class="other-lang">{% if detected_lang == 'en' %}VI{% else %}EN{% endif %}</span>
    </a>
  </li>
{% else %}
  <li class="language-switcher-nav">
    <a href="#" class="language-switcher-link" data-lang-selector="true" data-current-lang="{{ detected_lang }}" title="Select language">
      <span class="current-lang">{% if detected_lang == 'en' %}EN{% else %}VI{% endif %}</span> / <span class="other-lang">{% if detected_lang == 'en' %}VI{% else %}EN{% endif %}</span>
    </a>
  </li>
{% endif %}
